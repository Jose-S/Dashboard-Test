"use strict";var e=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};const s=require("@diez/cli-core"),r=require("@diez/compiler-core"),o=require("async"),t=require("chokidar"),c=require("fs-extra"),i=require("net"),a=require("path"),n=e(require("readline")),u=require("../utils"),d={sources:"./designs",assets:"./assets",code:"./src/designs",services:[]},l=new Set([".gitkeep"]),g=o.queue(async(e,r)=>{try{await u.performExtraction(e,global.process.cwd());for(const s of e.sockets)s.write(JSON.stringify({event:"reload"}))}catch(e){s.Log.warning(e)}finally{r()}});module.exports=(async({hot:e})=>{const o=(await s.findPlugins()).get("."),p={...d,...o?o.designs:void 0},f=await r.getProjectRoot();p.sources=a.resolve(f,p.sources),p.assets=a.resolve(f,p.assets),p.code=a.resolve(f,p.code),c.ensureDirSync(p.sources);const h=c.readdirSync(p.sources).map(e=>a.join(p.sources,e)).filter(e=>!l.has(a.basename(e))).concat(p.services);if(await Promise.all(h.map(async e=>{try{await u.performExtraction({source:e,assets:p.assets,code:p.code},f)}catch(e){return void s.Log.warning(e)}})),e){const e=a.join(global.process.cwd(),".diez","extract-port");if(c.existsSync(e))throw new Error(`Found existing hot extraction mutex at ${e}. If this is an error, please manually remove the file.`);const o=[],u=t.watch(p.sources,{useFsEvents:!1,ignoreInitial:!0});s.exitTrap(()=>{u.close()}),s.Log.info(`Watching ${s.Format.code(p.sources)} for changes...`),p.services.length&&s.Log.info(`Press ${s.Format.code("r")} to refresh design services...`);const d=process.stdin;d&&d.setRawMode&&(n.default.emitKeypressEvents(d),d.setRawMode(!0),d.on("keypress",(e,s)=>{if("r"===e)return g.push(p.services.map(e=>({sockets:o,source:e,assets:p.assets,code:p.code})));"c"===s.name&&s.ctrl&&process.exit()})),u.on("all",(e,s)=>{"add"!==e&&"change"!==e||g.push({sockets:o,source:s,assets:p.assets,code:p.code})});const l=await r.getHotPort(),f=i.createServer(e=>{s.socketTrap(e),o.push(e)});f.listen(l,"0.0.0.0",()=>{s.exitTrap(()=>{c.removeSync(e),f.close();for(const e of o)e.destroy();process.exit(0)}),c.writeFileSync(e,l),s.Log.info(`Serving hot assets on port ${l}.`)})}});
//# sourceMappingURL=/@diez/extractors-core/lib/commands/extract.action.js.map