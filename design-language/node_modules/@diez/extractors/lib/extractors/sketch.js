"use strict";const e=require("@diez/cli-core"),t=require("@diez/generation"),r=require("fs-extra"),a=require("path"),s=require("../utils"),o=".sketch",i=(t,r,o,i)=>{const n=`${t} export --format=png --scales=1,2,3,4 --output=${s.escapeShell(a.join(i,o))} ${o} ${s.escapeShell(r)}`;return e.execAsync(n)},n=e=>"MSArtboardGroup"!==e&&"MSPage"!==e,l=(e,r,s)=>{for(const o of r)o.exportOptions.exportFormats.length&&n(o["<class>"])&&t.registerAsset({src:a.join(e,t.AssetFolder.Slice,`${o.name}.png`),width:o.frame.width,height:o.frame.height},t.AssetFolder.Slice,s),o.layers&&l(e,o.layers,s)},c=(e,r,a)=>{(e=>0===e.gradientType)(e)&&a.gradients.push({name:r,initializer:(e=>{const r=e.stops.map(e=>({position:e.position,colorInitializer:t.getColorInitializer(e.color.value)}));return t.getLinearGradientInitializer(r,e.from,e.to)})(e)})},u=e=>{switch(e){case 0:return"TextAlignment.Left";case 1:return"TextAlignment.Right";case 2:return"TextAlignment.Center";case 4:return"TextAlignment.Natural";default:return}};class g{static create(){return new this}static async canParse(e){return await r.pathExists(e)&&a.extname(e.trim())===o}async export({source:o,assets:n,code:p},h,m=s.cliReporters){if(!await g.canParse(o))throw new Error("Invalid source file");if(!e.isMacOS())throw new Error("Sketch export is only supported on macOS");const S=await e.locateBinaryMacOS("com.bohemiancoding.sketch3"),f=`${S}/Contents/Resources/sketchtool/bin/sketchtool`;if(!S||!await r.pathExists(f))throw new Error("Unable to locate Sketch installation");const d=t.pascalCase(a.basename(o,".sketch")),w=`${d}.sketch`,y=a.join(n,`${w}.contents`);m.progress(`Creating necessary folders for ${w}`),await s.createFolders(y,[t.AssetFolder.Slice]),m.progress(`Running sketchtool export commands for ${w}`);const[x]=await Promise.all([e.execAsync(`${f} dump ${o}`,{maxBuffer:50331648}),i(f,o,t.AssetFolder.Slice,y)]);m.progress(`Extracting design tokens for ${w}`);const A=JSON.parse(x),b=t.createDesignLanguageSpec(d,y,a.join(p,`${w}.ts`),h);l(a.relative(h,y),A.pages,b.assets);for(const{name:e,color:{value:r}}of A.assets.colorAssets)b.colors.push({name:e,initializer:t.getColorInitializer(r)});for(const e of A.assets.gradientAssets)c(e.gradient,e.name,b);for(const e of A.layerStyles.objects.filter(e=>e.value.shadows.length)){const r=e.value.shadows[0],a=t.getDropShadowInitializer({colorInitializer:t.getColorInitializer(r.color.value),offset:{x:r.offsetX,y:r.offsetY},radius:r.blurRadius});b.shadows.push({initializer:a,name:`${e.name} Drop Shadow`})}for(const{name:r,value:{textStyle:a}}of A.layerTextStyles.objects){const s=a.NSFont.attributes.NSFontSizeAttribute,o=a.NSKern,i=a.NSParagraphStyle.style.maximumLineHeight,n=u(a.NSParagraphStyle.style.alignment),l=await t.locateFont(a.NSFont.family,{name:a.NSFont.attributes.NSFontNameAttribute});l?await t.registerFont(l,b.fonts):e.Log.warning(`Unable to locate system font assets for ${a.NSFont.attributes.NSFontNameAttribute}.`),b.typographs.push({name:r,initializer:t.getTypographInitializer(b.designLanguageName,l,a.NSFont.attributes.NSFontNameAttribute,{fontSize:s,letterSpacing:o,lineHeight:i,alignment:n,color:a.MSAttributedStringColorAttribute?t.getColorInitializer(a.MSAttributedStringColorAttribute.value):void 0})})}return t.codegenDesignLanguage(b)}}module.exports=g;
//# sourceMappingURL=/@diez/extractors/lib/extractors/sketch.js.map